drop table if exists Publisher;
drop table if exists BookIssue;
drop table if exists BookReview;
drop table if exists Quote;
drop table if exists UserBook;
drop table if exists "User";
drop table if exists Recommendation;
drop table if exists Book;
drop table if exists Genre;
drop table if exists Author;

create table Author
(
    id      int generated by default as identity PRIMARY KEY,
    name    varchar(50) NOT NULL,
    surname varchar(50),
    country varchar
);

create table Genre
(
    id         int generated by default as identity PRIMARY KEY,
    name       varchar(100) UNIQUE CHECK ( REGEXP_MATCH(name, '[A-Za-zа-я-А-ЯёЁ]') ) NOT NULL,
    is_fiction bool default true
);

create table Book
(
    id        int generated by default as identity PRIMARY KEY,
    author_id int references Author (id) on delete cascade NOT NULL,
    genre_id  int references Genre (id) on delete set null,
    title     varchar(100) NOT NULL,
    series    varchar(100),
    UNIQUE (author_id, title)
);

create table Recommendation
(
    book_id   int references Book (id) on delete cascade NOT NULL,
    author_id int references Author (id) on delete cascade NOT NULL,
    primary key (book_id, author_id)
);

create table "User"
(
    id       int generated by default as identity PRIMARY KEY,
    login    varchar(10) NOT NULL,
    password varchar(10) NOT NULL,
    is_admin boolean     NOT NULL default false
);

create table UserBook
(
    book_id     int references Book (id) on delete cascade NOT NULL,
    user_id     int references "User" (id) on delete cascade NOT NULL,
    primary key (book_id, user_id),

    is_read     bool default false,
    is_demanded bool default false
);

create table Quote
(
    id       int generated by default as identity PRIMARY KEY,
    book_id  int references Book (id) NOT NULL,
    page     int CHECK ( page > 0 ) NOT NULL,
    contents varchar NOT NULL
);

create table BookReview
(
    id       int primary key references Book (id),
    user_id  int references "User" (id) ,
    book_id  int references Book (id),
    rating   int          NOT NULL,
    contents varchar(100) NOT NULL
);

create table Publisher
(
    id      int generated by default as identity PRIMARY KEY,
    name    varchar(30) NOT NULL,
    address varchar     NOT NULL,
    phone   varchar
);

create table BookIssue
(
    id           int generated by default as identity PRIMARY KEY,
    book_id      int references Book (id) NOT NULL,
    publisher_id int references Publisher (id) NOT NULL,

    year         int NOT NULL,
    quantity     int NOT NULL,
    price        double precision
);

-- ЗАПОЛНЕНИЕ ТАБЛИЦЫ Author ТЕСТОВЫМИ ЗНАЧЕНИЯМИ
insert into Author(name, surname, country)
values ('Фёдор', 'Достоевский', 'Россия');
insert into Author(name, surname, country)
values ('Лев', 'Толстой', 'Россия');
insert into Author(name, surname, country)
values ('Михаил', 'Булгаков', 'СССР');
insert into Author(name, surname, country)
values ('Михаил', 'Шолохов', 'СССР');
insert into Author(name, surname, country)
values ('Стивен', 'Кинг', 'США');
insert into Author(name, surname, country)
values ('Айзек', 'Азимов', 'США');
insert into Author(name, surname, country)
values ('Нассим Николас', 'Талеб', 'США');
insert into Author(name, surname, country)
values ('Агата', 'Кристи', 'Великобритания');
insert into Author(name, surname, country)
values ('Артур Конан', 'Дойл', 'Великобритания');
insert into Author(name, surname, country)
values ('Станислав', 'Лем', 'Польша');
insert into Author(name, surname, country)
values ('Генрик', 'Сенкевич', 'Польша');
insert into Author(name, surname, country)
values ('Болеслав', 'Прус', 'Польша');
insert into Author(name, surname, country)
values ('Александр', 'Дюма', 'Франция');
insert into Author(name, surname, country)
values ('Мишель', 'Фуко', 'Франция');
insert into Author(name, surname, country)
values ('Марсель', 'Пруст', 'Франция');

-- ЗАПОЛНЕНИЕ ТАБЛИЦЫ Genre ТЕСТОВЫМИ ЗНАЧЕНИЯМИ
insert into Genre(name)
values ('Фантастика');
insert into Genre(name)
values ('Исторический роман');
insert into Genre(name)
values ('Психологический роман');
insert into Genre(name)
values ('Фэнтэзи');
insert into Genre(name)
values ('Детектив');
insert into Genre(name, is_fiction)
values ('Философия', false);
insert into Genre(name, is_fiction)
values ('Экономика', false);
insert into Genre(name)
values ('Ужасы');
insert into Genre(name)
values ('Приключения');

-- ЗАПОЛНЕНИЕ ТАБЛИЦЫ Book ТЕСТОВЫМИ ЗНАЧЕНИЯМИ
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (1, 'Преступление и наказание', 'Романы Достоевского', 3);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (1, 'Братья Карамазовы', 'Романы Достоевского', 3);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (2, 'Война и мир', 'Романы Толстого', 2);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (2, 'Анна Каренина', 'Романы Толстого', 3);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (3, 'Мастер и Маргарита', NULL, 4);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (4, 'Тихий Дон', NULL, 2);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (5, 'Оно', 'Цикл "Оно"', 8);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (6, 'Я, робот', NULL, 1);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (7, 'Чёрный лебедь', NULL, 7);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (8, 'Убийство в Восточном экспрессе', 'Эркюль Пуаро', 5);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (9, 'Приключения Шерлока Холмса', 'Шерлок Холмс', 5);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (10, 'Солярис', NULL, 1);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (11, 'Камо грядеши', NULL, 2);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (12, 'Фараон', NULL, 2);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (13, 'Граф Монте-Кристо', NULL, 2);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (14, 'Надзирать и наказывать', NULL, 6);
INSERT INTO Book (author_id, title, series, genre_id)
VALUES (15, 'В поисках утраченного времени', 'В поисках утраченного времени', 3);

-- ЗАПОЛНЕНИЕ ТАБЛИЦЫ Recommendation ТЕСТОВЫМИ ЗНАЧЕНИЯМИ
INSERT INTO Recommendation (book_id, author_id)
VALUES (1, 2);
INSERT INTO Recommendation (book_id, author_id)
VALUES (4, 5);
INSERT INTO Recommendation (book_id, author_id)
VALUES (1, 4);
INSERT INTO Recommendation (book_id, author_id)
VALUES (3, 7);

-- ЗАПОЛНЕНИЕ ТАБЛИЦЫ User ТЕСТОВЫМИ ЗНАЧЕНИЯМИ
INSERT INTO "User" (login, password, is_admin)
values ('victor', 'victor', true);
INSERT INTO "User" (login, password)
values ('pliska', 'pliska');